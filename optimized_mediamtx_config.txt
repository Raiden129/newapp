# Optimized MediaMTX Configuration for Low Latency and Stability

###############################################
# Global settings -> General

logLevel: info
logDestinations: [stdout]
logFile: mediamtx.log

# Increased timeouts for stability with unstable sources
readTimeout: 30s
writeTimeout: 30s
# Increased queue size for stability with unstable sources
writeQueueSize: 8192
udpMaxPayloadSize: 1472

###############################################
# Global settings -> RTSP server

rtsp: yes
rtspTransports: [tcp]  # TCP only for stability, remove UDP to prevent packet loss
rtspEncryption: "no"
rtspAddress: :8554
rtpAddress: :8000
rtcpAddress: :8001
rtspAuthMethods: [basic]
# Increased buffer for stability
rtspUDPReadBufferSize: 4194304  # 4MB buffer

###############################################
# Global settings -> RTMP server

rtmp: yes
rtmpAddress: :1935
rtmpEncryption: "no"

###############################################
# Global settings -> HLS server (Fixed Duration for iOS Compatibility)

hls: yes
hlsAddress: :8888
hlsEncryption: no
hlsAllowOrigin: '*'
hlsTrustedProxies: []
hlsAlwaysRemux: yes
# Use standard HLS for better compatibility
hlsVariant: standard
# Fixed segment count for consistency
hlsSegmentCount: 6
# Fixed segment duration to prevent iOS errors
hlsSegmentDuration: 4s
# Fixed part duration to prevent iOS errors
hlsPartDuration: 400ms
hlsSegmentMaxSize: 50M
hlsDirectory: ''
# Increased close time for stability
hlsMuxerCloseAfter: 60s

###############################################
# Global settings -> WebRTC server (Lowest Latency Option)

webrtc: yes
webrtcAddress: :8889
webrtcEncryption: no
webrtcAllowOrigin: '*'
webrtcTrustedProxies: []
webrtcLocalUDPAddress: :8189
# Gather IPs for connectivity
webrtcIPsFromInterfaces: yes
webrtcIPsFromInterfacesList: []
webrtcAdditionalHosts: []
webrtcICEServers2: []
# Increased timeouts for stability
webrtcHandshakeTimeout: 10s
webrtcTrackGatherTimeout: 5s
webrtcSTUNGatherTimeout: 10s

###############################################
# Global settings -> SRT server

srt: yes
srtAddress: :8890

###############################################
# Optimized Path Defaults for Stability

pathDefaults:
  source: publisher
  sourceFingerprint:
  # Disable on-demand for stability
  sourceOnDemand: no
  sourceOnDemandStartTimeout: 10s
  sourceOnDemandCloseAfter: 120s
  maxReaders: 0
  srtReadPassphrase:
  fallback:
  # Use original timestamps for better synchronization
  useAbsoluteTimestamp: true
  
  # Publisher settings for stability
  overridePublisher: yes
  srtPublishPassphrase:
  
  # RTSP source settings optimized for your cameras
  rtspTransport: tcp  # TCP only for stability
  rtspAnyPort: no
  rtspRangeType:
  rtspRangeStart:
  # Larger buffer for unstable sources
  rtspUDPReadBufferSize: 4194304  # 4MB
  # Increased timeout for unstable sources
  rtspTimeout: 30s

###############################################
# Camera-specific paths with optimizations

paths:
  cam1:
    source: rtsp://admin:WIQQAU@192.168.0.2:554
    rtspTransport: tcp
    # Keep always connected for stability
    sourceOnDemand: no
    sourceOnDemandStartTimeout: 10s
    sourceOnDemandCloseAfter: 120s
    # Larger buffer for this camera
    rtspUDPReadBufferSize: 8388608  # 8MB for main camera
    rtspTimeout: 45s
    # Enable fallback for stability
    fallback: cam1_backup
    
  cam2:
    source: rtsp://admin:QVKTZJ@192.168.0.3:554
    rtspTransport: tcp
    sourceOnDemand: no
    sourceOnDemandStartTimeout: 10s
    sourceOnDemandCloseAfter: 120s
    rtspUDPReadBufferSize: 8388608
    rtspTimeout: 45s
    # Enable fallback for stability
    fallback: cam2_backup
    
  cam3_fixed:
    source: rtsp://admin:WAYPTA@192.168.0.4:554/Streaming/Channels/102
    rtspTransport: tcp
    sourceOnDemand: no
    sourceOnDemandStartTimeout: 10s
    sourceOnDemandCloseAfter: 120s
    rtspUDPReadBufferSize: 8388608
    rtspTimeout: 45s
    # Add retry mechanism
    sourceOnDemandRetryDelay: 5s
    sourceOnDemandMaxRetries: 3
    
  cam4:
    source: rtsp://admin%40123:Admin%40123@192.168.0.8:554/stream2
    rtspTransport: tcp
    sourceOnDemand: no
    sourceOnDemandStartTimeout: 10s
    sourceOnDemandCloseAfter: 120s
    rtspUDPReadBufferSize: 8388608
    rtspTimeout: 45s

  # Fallback streams for critical cameras
  cam1_backup:
    source: rtsp://admin:WIQQAU@192.168.0.2:554/backup
    rtspTransport: tcp
    sourceOnDemand: yes
    sourceOnDemandStartTimeout: 5s
    sourceOnDemandCloseAfter: 60s
    rtspUDPReadBufferSize: 4194304
    
  cam2_backup:
    source: rtsp://admin:QVKTZJ@192.168.0.3:554/backup
    rtspTransport: tcp
    sourceOnDemand: yes
    sourceOnDemandStartTimeout: 5s
    sourceOnDemandCloseAfter: 60s
    rtspUDPReadBufferSize: 4194304

###############################################
# Optional: Enable API for monitoring

api: yes
apiAddress: :9997
apiEncryption: no
apiAllowOrigin: '*'

# Optional: Enable metrics for monitoring stream health
metrics: yes
metricsAddress: :9998
metricsEncryption: no
metricsAllowOrigin: '*'