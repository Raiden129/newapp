# Optimized MediaMTX Configuration for Low Latency and Stability

###############################################
# Global settings -> General

logLevel: info
logDestinations: [stdout]
logFile: mediamtx.log

# Reduced timeouts for lower latency
readTimeout: 10s
writeTimeout: 10s
# Increased queue size for stability with unstable sources
writeQueueSize: 4096
udpMaxPayloadSize: 1472

###############################################
# Global settings -> RTSP server

rtsp: yes
rtspTransports: [tcp, udp]  # TCP first for stability, UDP as fallback
rtspEncryption: "no"
rtspAddress: :8554
rtpAddress: :8000
rtcpAddress: :8001
rtspAuthMethods: [basic]
# Increased buffer for stability
rtspUDPReadBufferSize: 2097152  # 2MB buffer

###############################################
# Global settings -> RTMP server

rtmp: yes
rtmpAddress: :1935
rtmpEncryption: "no"

###############################################
# Global settings -> HLS server (Optimized for Low Latency)

hls: yes
hlsAddress: :8888
hlsEncryption: no
hlsAllowOrigin: '*'
hlsTrustedProxies: []
hlsAlwaysRemux: yes  # Keep this for immediate availability
# Use Low-Latency HLS for minimal delay
hlsVariant: lowLatency
# Reduced segment count for lower latency
hlsSegmentCount: 3
# Much shorter segments for low latency
hlsSegmentDuration: 2s
# Very short parts for LL-HLS
hlsPartDuration: 200ms
hlsSegmentMaxSize: 50M
hlsDirectory: ''
# Reduced close time for responsiveness
hlsMuxerCloseAfter: 30s

###############################################
# Global settings -> WebRTC server (Lowest Latency Option)

webrtc: yes
webrtcAddress: :8889
webrtcEncryption: no
webrtcAllowOrigin: '*'
webrtcTrustedProxies: []
webrtcLocalUDPAddress: :8189
# Gather IPs for connectivity
webrtcIPsFromInterfaces: yes
webrtcIPsFromInterfacesList: []
webrtcAdditionalHosts: []
webrtcICEServers2: []
# Reduced timeouts for faster connection
webrtcHandshakeTimeout: 5s
webrtcTrackGatherTimeout: 1s
webrtcSTUNGatherTimeout: 3s

###############################################
# Global settings -> SRT server

srt: yes
srtAddress: :8890

###############################################
# Optimized Path Defaults for Stability

pathDefaults:
  source: publisher
  sourceFingerprint:
  # Enable on-demand for efficiency but with quick start
  sourceOnDemand: yes
  sourceOnDemandStartTimeout: 5s
  sourceOnDemandCloseAfter: 30s
  maxReaders: 0
  srtReadPassphrase:
  fallback:
  # Use original timestamps for better synchronization
  useAbsoluteTimestamp: true
  
  # Publisher settings for stability
  overridePublisher: yes
  srtPublishPassphrase:
  
  # RTSP source settings optimized for your cameras
  rtspTransport: tcp  # TCP is more reliable for unstable networks
  rtspAnyPort: no
  rtspRangeType:
  rtspRangeStart:
  # Larger buffer for unstable sources
  rtspUDPReadBufferSize: 2097152  # 2MB

###############################################
# Camera-specific paths with optimizations

paths:
  cam1:
    source: rtsp://admin:WIQQAU@192.168.0.2:554
    rtspTransport: tcp
    # Quick reconnection for unstable sources
    sourceOnDemand: no  # Keep always connected for main cameras
    sourceOnDemandStartTimeout: 3s
    sourceOnDemandCloseAfter: 60s
    # Larger buffer for this camera
    rtspUDPReadBufferSize: 4194304  # 4MB for main camera
    
  cam2:
    source: rtsp://admin:QVKTZJ@192.168.0.3:554
    rtspTransport: tcp
    sourceOnDemand: no
    sourceOnDemandStartTimeout: 3s
    sourceOnDemandCloseAfter: 60s
    rtspUDPReadBufferSize: 4194304
    
  cam3_fixed:
    source: rtsp://admin:WAYPTA@192.168.0.4:554/Streaming/Channels/102
    rtspTransport: tcp
    sourceOnDemand: no
    sourceOnDemandStartTimeout: 3s
    sourceOnDemandCloseAfter: 60s
    rtspUDPReadBufferSize: 4194304
    
  cam4:
    source: rtsp://admin%40123:Admin%40123@192.168.0.8:554/stream2
    rtspTransport: tcp
    sourceOnDemand: no
    sourceOnDemandStartTimeout: 3s
    sourceOnDemandCloseAfter: 60s
    rtspUDPReadBufferSize: 4194304

  # Optional: Add fallback streams for critical cameras
  cam1_backup:
    source: rtsp://admin:WIQQAU@192.168.0.2:554/backup
    rtspTransport: tcp
    sourceOnDemand: yes
    fallback: cam1

###############################################
# Optional: Enable API for monitoring

api: yes
apiAddress: :9997
apiEncryption: no
apiAllowOrigin: '*'

# Optional: Enable metrics for monitoring stream health
metrics: yes
metricsAddress: :9998
metricsEncryption: no
metricsAllowOrigin: '*'